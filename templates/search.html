{% extends "base.html" %}

{% block title %}Search - Knowledge Hub{% endblock %}

{% block content %}
<div class="page-header">
    <h1>Search Response Scripts</h1>
</div>

<!-- Search Form -->
<div class="search-container">
    <form method="GET" class="search-form">
        <input type="text" name="q" value="{{ query }}" placeholder="Describe the customer's problem..." class="search-input-large" autofocus>
        <select name="type" class="search-type-select">
            <option value="semantic" {% if search_type == 'semantic' %}selected{% endif %}>Semantic Search (AI)</option>
            <option value="text" {% if search_type == 'text' %}selected{% endif %}>Text Search</option>
        </select>
        <button type="submit" class="btn btn-primary">Search</button>
    </form>
</div>

{% if query %}
<!-- Results -->
<div class="search-results">
    {% if results and results.questions %}
        <div class="result-section">
            <h2>{% if results.is_semantic %}Similar Questions{% else %}Matching Questions{% endif %} ({{ results.questions|length }})</h2>
            {% if results.is_semantic %}
            <p class="result-description">Questions semantically similar to your query. Click Copy to use the best script.</p>
            {% endif %}
            <div class="result-list">
                {% for item in results.questions %}
                <div class="result-item {% if results.is_semantic %}semantic-result{% endif %}">
                    {% if results.is_semantic %}
                    <div class="similarity-score">
                        <div class="score-circle" style="--score: {{ item.similarity }}">
                            {{ item.similarity }}%
                        </div>
                        <span class="score-label">match</span>
                    </div>
                    {% endif %}
                    <div class="result-content-area">
                        <a href="{{ url_for('question_detail', question_id=item.id) }}" class="result-title">
                            {{ item.canonical_text }}
                        </a>
                        <div class="result-meta">
                            <span class="cluster-badge" style="background-color: {{ item.cluster_color }}">
                                {{ item.cluster_icon }} {{ item.cluster_name }}
                            </span>
                            <span class="times-asked">{{ item.times_asked }}x asked</span>
                            <span class="status-badge status-{{ item.status }}">{{ item.status }}</span>
                            {% if item.script_count %}
                            <span class="script-count">{{ item.script_count }} scripts</span>
                            {% endif %}
                        </div>

                        <!-- Best Script Preview -->
                        {% if item.best_script %}
                        <div class="best-script-preview">
                            <div class="script-preview-header">
                                <span class="best-label">Best Response ({{ item.best_script.effectiveness|round(0)|int }}%)</span>
                                <button onclick="copyScript({{ item.best_script.id }})" class="btn-copy-small">Copy</button>
                            </div>
                            <div class="script-preview-text">{{ item.best_script.text|truncate(200) }}</div>
                        </div>
                        {% endif %}
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
    {% else %}
    <div class="empty-state">
        <h3>No results found</h3>
        <p>Try different keywords or {% if search_type == 'semantic' %}use text search{% else %}use semantic search{% endif %}.</p>
    </div>
    {% endif %}
</div>
{% else %}
<!-- Search Tips -->
<div class="search-tips">
    <h2>Search Tips</h2>
    <ul>
        <li><strong>Semantic Search (AI):</strong> Describe the problem in natural language. Our AI will find questions with similar meaning.</li>
        <li><strong>Text Search:</strong> Find exact keyword matches in questions.</li>
        <li>Example: "phone won't turn on" will match "device not powering up" in semantic search.</li>
        <li><strong>Quick Copy:</strong> Click "Copy" next to any result to copy the best response script to your clipboard.</li>
    </ul>
</div>
{% endif %}

<!-- Copy Success Toast -->
<div id="toast" class="toast">Copied to clipboard!</div>
{% endblock %}

{% block head %}
<style>
.search-type-select {
    padding: 1rem;
    font-size: 1rem;
    border: 2px solid #ddd;
    border-radius: 8px;
    background: white;
    min-width: 180px;
}

.result-description {
    color: #666;
    margin-bottom: 1rem;
    font-size: 0.9rem;
}

.semantic-result {
    display: flex;
    gap: 1.5rem;
    align-items: flex-start;
}

.similarity-score {
    display: flex;
    flex-direction: column;
    align-items: center;
    min-width: 70px;
}

.score-circle {
    width: 60px;
    height: 60px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
    font-size: 0.9rem;
    background: conic-gradient(
        #4a90d9 calc(var(--score) * 1%),
        #e9ecef calc(var(--score) * 1%)
    );
    position: relative;
}

.score-circle::before {
    content: '';
    position: absolute;
    width: 50px;
    height: 50px;
    background: white;
    border-radius: 50%;
}

.score-label {
    font-size: 0.75rem;
    color: #888;
    margin-top: 0.25rem;
}

.result-content-area {
    flex: 1;
}

.result-content-area .result-title {
    font-size: 1.1rem;
    display: block;
    margin-bottom: 0.5rem;
}

.result-meta {
    display: flex;
    gap: 0.75rem;
    align-items: center;
    flex-wrap: wrap;
    margin-bottom: 0.75rem;
}

.script-count {
    color: #28a745;
    font-weight: 500;
    font-size: 0.85rem;
}

/* Best Script Preview */
.best-script-preview {
    background: #f0fff0;
    border: 1px solid #c3e6cb;
    border-radius: 8px;
    padding: 12px;
    margin-top: 12px;
}

.script-preview-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 8px;
}

.best-label {
    color: #28a745;
    font-weight: bold;
    font-size: 0.85rem;
}

.btn-copy-small {
    background: #007bff;
    color: white;
    border: none;
    padding: 6px 16px;
    border-radius: 4px;
    cursor: pointer;
    font-size: 0.85rem;
    font-weight: 500;
    transition: all 0.2s;
}

.btn-copy-small:hover {
    background: #0056b3;
}

.script-preview-text {
    color: #333;
    line-height: 1.5;
    font-size: 0.95rem;
    white-space: pre-wrap;
}

/* Toast notification */
.toast {
    position: fixed;
    bottom: 20px;
    left: 50%;
    transform: translateX(-50%);
    background: #333;
    color: white;
    padding: 12px 24px;
    border-radius: 8px;
    opacity: 0;
    transition: opacity 0.3s;
    z-index: 1000;
}

.toast.show {
    opacity: 1;
}
</style>
{% endblock %}

{% block scripts %}
<script>
function copyScript(id) {
    fetch('/api/script/' + id + '/copy')
        .then(r => r.json())
        .then(data => {
            if (data.text) {
                navigator.clipboard.writeText(data.text).then(() => {
                    showToast('Copied to clipboard!');
                }).catch(() => {
                    // Fallback for older browsers
                    const textarea = document.createElement('textarea');
                    textarea.value = data.text;
                    document.body.appendChild(textarea);
                    textarea.select();
                    document.execCommand('copy');
                    document.body.removeChild(textarea);
                    showToast('Copied to clipboard!');
                });
            }
        });
}

function showToast(message) {
    const toast = document.getElementById('toast');
    toast.textContent = message;
    toast.classList.add('show');
    setTimeout(() => toast.classList.remove('show'), 2000);
}
</script>
{% endblock %}
