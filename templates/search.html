{% extends "base.html" %}

{% block title %}Search - Call Analyzer{% endblock %}

{% block content %}
<div class="page-header">
    <h1>Smart Search</h1>
</div>

<!-- Search Form -->
<div class="search-container">
    <form method="GET" class="search-form">
        <input type="text" name="q" value="{{ query }}" placeholder="Describe the customer's problem..." class="search-input-large" autofocus>
        <select name="type" class="search-type-select">
            <option value="semantic" {% if search_type == 'semantic' %}selected{% endif %}>Semantic Search (AI)</option>
            <option value="text" {% if search_type == 'text' %}selected{% endif %}>Text Search</option>
        </select>
        <button type="submit" class="btn btn-primary">Search</button>
    </form>
</div>

{% if query %}
<!-- Results -->
<div class="search-results">
    {% if results %}
        {% if results.is_semantic %}
        <!-- Semantic Search Results -->
        {% if results.questions %}
        <div class="result-section">
            <h2>Similar Questions Found ({{ results.questions|length }})</h2>
            <p class="result-description">Questions semantically similar to your query, ranked by AI similarity score.</p>
            <div class="result-list">
                {% for item in results.questions %}
                <div class="result-item semantic-result">
                    <div class="similarity-score">
                        <div class="score-circle" style="--score: {{ item.similarity }}">
                            {{ item.similarity }}%
                        </div>
                        <span class="score-label">match</span>
                    </div>
                    <div class="result-content-area">
                        <a href="{{ url_for('solution_detail', question_id=item.id) }}" class="result-title">
                            {{ item.canonical_text }}
                        </a>
                        <div class="result-meta">
                            <span class="badge" style="background: {{ item.topic_color }}20; color: {{ item.topic_color }}">
                                {{ item.topic_icon }} {{ item.topic_name }}
                            </span>
                            <span class="times-asked">{{ item.times_asked }}x asked</span>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
        {% else %}
        <div class="empty-state">
            <h3>No similar questions found</h3>
            <p>Try rephrasing your query or use text search for exact matches.</p>
        </div>
        {% endif %}

        {% else %}
        <!-- Text Search Results -->

        <!-- Questions -->
        {% if results.questions %}
        <div class="result-section">
            <h2>Questions ({{ results.questions|length }})</h2>
            <div class="result-list">
                {% for item in results.questions %}
                <div class="result-item">
                    <a href="{{ url_for('solution_detail', question_id=item.id) }}" class="result-title">
                        {{ item.canonical_text }}
                    </a>
                    <div class="result-meta">
                        <span class="badge" style="background: {{ item.topic_color }}20; color: {{ item.topic_color }}">
                            {{ item.topic_icon }} {{ item.topic_name }}
                        </span>
                        <span class="times-asked">{{ item.times_asked }}x asked</span>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
        {% endif %}

        <!-- Answers -->
        {% if results.answers %}
        <div class="result-section">
            <h2>Answers ({{ results.answers|length }})</h2>
            <div class="result-list">
                {% for item in results.answers %}
                <div class="result-item">
                    <div class="result-title">{{ item.question_text|truncate_text(100) }}</div>
                    <div class="result-content">{{ item.answer_text|truncate_text(200) }}</div>
                    <div class="result-meta">
                        Effectiveness: {{ item.effectiveness_score|round(0)|int }}%
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
        {% endif %}

        <!-- Knowledge -->
        {% if results.knowledge %}
        <div class="result-section">
            <h2>Knowledge Base ({{ results.knowledge|length }})</h2>
            <div class="result-list">
                {% for item in results.knowledge %}
                <div class="result-item">
                    <div class="result-title">{{ item.title }}</div>
                    <div class="result-content">{{ item.content|truncate_text(200) }}</div>
                    {% if item.category %}
                    <span class="badge badge-category">{{ item.category }}</span>
                    {% endif %}
                </div>
                {% endfor %}
            </div>
        </div>
        {% endif %}

        <!-- Documents -->
        {% if results.documents %}
        <div class="result-section">
            <h2>Documents ({{ results.documents|length }})</h2>
            <div class="result-list">
                {% for doc in results.documents %}
                <div class="result-item">
                    <div class="result-title">
                        <a href="{{ url_for('document_detail', doc_id=doc.id) }}">{{ doc.filename }}</a>
                    </div>
                    <div class="result-meta">
                        <span class="badge badge-type">{{ doc.type }}</span>
                        <span class="badge badge-{{ doc.status }}">{{ doc.status }}</span>
                        {{ doc.created_at|datetime }}
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
        {% endif %}

        {% if not results.questions and not results.answers and not results.knowledge and not results.documents %}
        <div class="empty-state">
            <h3>No results found</h3>
            <p>Try different keywords or use semantic search for AI-powered matching.</p>
        </div>
        {% endif %}
        {% endif %}
    {% else %}
        <div class="empty-state">
            <h3>No results found</h3>
            <p>Try different keywords or check the spelling</p>
        </div>
    {% endif %}
</div>
{% else %}
<!-- Search Tips -->
<div class="search-tips">
    <h2>Search Tips</h2>
    <ul>
        <li><strong>Semantic Search (AI):</strong> Describe the problem in natural language. Our AI will find questions with similar meaning, even if the words are different.</li>
        <li><strong>Text Search:</strong> Find exact keyword matches across all questions, answers, and knowledge base.</li>
        <li>Example: "phone won't turn on" will match "device not powering up" in semantic search.</li>
        <li>Use semantic search when you want to find related problems that customers might describe differently.</li>
    </ul>
</div>
{% endif %}
{% endblock %}

{% block head %}
<style>
.search-type-select {
    padding: 1rem;
    font-size: 1rem;
    border: 2px solid #ddd;
    border-radius: 8px;
    background: white;
    min-width: 180px;
}

.result-description {
    color: #666;
    margin-bottom: 1rem;
    font-size: 0.9rem;
}

.semantic-result {
    display: flex;
    gap: 1.5rem;
    align-items: flex-start;
}

.similarity-score {
    display: flex;
    flex-direction: column;
    align-items: center;
    min-width: 70px;
}

.score-circle {
    width: 60px;
    height: 60px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
    font-size: 0.9rem;
    background: conic-gradient(
        #4a90d9 calc(var(--score) * 1%),
        #e9ecef calc(var(--score) * 1%)
    );
    position: relative;
}

.score-circle::before {
    content: '';
    position: absolute;
    width: 50px;
    height: 50px;
    background: white;
    border-radius: 50%;
}

.score-circle::after {
    content: attr(style);
    position: relative;
    z-index: 1;
}

.score-label {
    font-size: 0.75rem;
    color: #888;
    margin-top: 0.25rem;
}

.result-content-area {
    flex: 1;
}

.result-content-area .result-title {
    font-size: 1.1rem;
    display: block;
    margin-bottom: 0.5rem;
}
</style>
{% endblock %}
