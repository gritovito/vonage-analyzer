{% extends "base.html" %}

{% block title %}Search - Response Scripts Library{% endblock %}

{% block content %}
<div class="page-header">
    <h1>Search Response Scripts</h1>
</div>

<!-- Search Form -->
<div class="search-container">
    <form method="GET" class="search-form">
        <div class="search-input-wrapper">
            <input type="text" name="q" value="{{ query }}" placeholder="Describe the customer problem..."
                   class="search-input-large" id="searchInput" autocomplete="off" autofocus>
            <div class="autocomplete-dropdown" id="autocompleteDropdown"></div>
        </div>
        <select name="type" class="search-type-select">
            <option value="semantic" {% if search_type == 'semantic' %}selected{% endif %}>Semantic (AI)</option>
            <option value="text" {% if search_type == 'text' %}selected{% endif %}>Text Search</option>
        </select>
        <button type="submit" class="btn btn-primary btn-lg">Search</button>
    </form>
</div>

{% if query %}
<!-- Results -->
<div class="search-results">
    {% if results and results.questions %}
        <div class="results-header">
            <h2>{% if results.is_semantic %}Similar Questions{% else %}Matching Questions{% endif %}</h2>
            <span class="results-count">{{ results.questions|length }} results</span>
        </div>

        {% if results.is_semantic %}
        <p class="results-hint">Questions semantically similar to your query. Click "Copy" to copy the best script.</p>
        {% endif %}

        <div class="results-list">
            {% for item in results.questions %}
            <div class="result-card {% if results.is_semantic %}semantic{% endif %}">
                {% if results.is_semantic %}
                <div class="similarity-badge">
                    <span class="similarity-value">{{ item.similarity }}%</span>
                    <span class="similarity-label">match</span>
                </div>
                {% endif %}

                <div class="result-content">
                    <a href="{{ url_for('question_detail', question_id=item.id) }}" class="result-title">
                        {{ item.canonical_text }}
                    </a>

                    <div class="result-meta">
                        <span class="cluster-tag" style="background-color: {{ item.cluster_color }}20; color: {{ item.cluster_color }}">
                            {{ item.cluster_icon }} {{ item.cluster_name }}
                        </span>
                        <span class="times-asked">{{ item.times_asked }}x asked</span>
                        <span class="status-badge status-{{ item.status }}">{{ item.status }}</span>
                        {% if item.script_count %}
                        <span class="script-count">{{ item.script_count }} scripts</span>
                        {% endif %}
                    </div>

                    {% if item.best_script %}
                    <div class="best-script-card">
                        <div class="script-header">
                            <span class="script-badge">Best Response ({{ item.best_script.effectiveness|round(0)|int }}%)</span>
                            <button onclick="copyScript({{ item.best_script.id }})" class="btn-copy">Copy</button>
                        </div>
                        <div class="script-preview">{{ item.best_script.text|truncate(250) }}</div>
                    </div>
                    {% endif %}
                </div>
            </div>
            {% endfor %}
        </div>
    {% else %}
    <div class="empty-results">
        <h3>No results found</h3>
        <p>Try different keywords or {% if search_type == 'semantic' %}switch to text search{% else %}switch to semantic search{% endif %}.</p>
    </div>
    {% endif %}
</div>
{% else %}
<!-- Search Tips -->
<div class="search-tips-section">
    <h2>Search Tips</h2>
    <div class="tips-grid">
        <div class="tip-card">
            <div class="tip-icon">AI</div>
            <h3>Semantic Search</h3>
            <p>Describe the problem in natural language. AI finds questions with similar meaning.</p>
            <code>"phone won't turn on"</code> matches <code>"device not powering up"</code>
        </div>
        <div class="tip-card">
            <div class="tip-icon">Aa</div>
            <h3>Text Search</h3>
            <p>Find exact keyword matches. Good for specific terms.</p>
            <code>"charging"</code> finds all questions with that word
        </div>
        <div class="tip-card">
            <div class="tip-icon">C</div>
            <h3>Quick Copy</h3>
            <p>Click "Copy" to copy the best response script to clipboard instantly.</p>
        </div>
    </div>
</div>
{% endif %}

<!-- Toast notification -->
<div id="toast" class="toast">Copied to clipboard!</div>
{% endblock %}

{% block scripts %}
<script>
// Autocomplete
const searchInput = document.getElementById('searchInput');
const dropdown = document.getElementById('autocompleteDropdown');
let debounceTimer;

if (searchInput) {
    searchInput.addEventListener('input', function() {
        clearTimeout(debounceTimer);
        const query = this.value.trim();

        if (query.length < 2) {
            dropdown.style.display = 'none';
            return;
        }

        debounceTimer = setTimeout(() => {
            fetch('/api/autocomplete?q=' + encodeURIComponent(query))
                .then(r => r.json())
                .then(suggestions => {
                    if (suggestions.length === 0) {
                        dropdown.style.display = 'none';
                        return;
                    }

                    dropdown.innerHTML = suggestions.map(s =>
                        `<div class="autocomplete-item" onclick="selectSuggestion('${s.replace(/'/g, "\\'")}')">${s}</div>`
                    ).join('');
                    dropdown.style.display = 'block';
                });
        }, 200);
    });

    searchInput.addEventListener('blur', () => {
        setTimeout(() => dropdown.style.display = 'none', 200);
    });
}

function selectSuggestion(text) {
    searchInput.value = text;
    dropdown.style.display = 'none';
    searchInput.closest('form').submit();
}

function copyScript(id) {
    fetch('/api/script/' + id + '/copy')
        .then(r => r.json())
        .then(data => {
            if (data.text) {
                navigator.clipboard.writeText(data.text).then(() => {
                    showToast('Copied to clipboard!');
                }).catch(() => {
                    const textarea = document.createElement('textarea');
                    textarea.value = data.text;
                    document.body.appendChild(textarea);
                    textarea.select();
                    document.execCommand('copy');
                    document.body.removeChild(textarea);
                    showToast('Copied to clipboard!');
                });
            }
        });
}

function showToast(message) {
    const toast = document.getElementById('toast');
    toast.textContent = message;
    toast.classList.add('show');
    setTimeout(() => toast.classList.remove('show'), 2000);
}
</script>
{% endblock %}
