{% extends "base.html" %}

{% block title %}{{ document.filename }} - Call Analyzer{% endblock %}

{% block content %}
<div class="page-header">
    <h1>Document Details</h1>
    <a href="{{ url_for('documents') }}" class="btn">&laquo; Back to Documents</a>
</div>

<div class="document-detail">
    <!-- Document Info -->
    <div class="card">
        <div class="card-header">
            <h2>{{ document.filename }}</h2>
            <span class="badge badge-{{ document.status }}">{{ document.status }}</span>
        </div>
        <div class="card-body">
            <div class="meta-grid">
                <div class="meta-item">
                    <span class="meta-label">ID:</span>
                    <span class="meta-value">{{ document.id }}</span>
                </div>
                <div class="meta-item">
                    <span class="meta-label">Type:</span>
                    <span class="meta-value">{{ doc_types.get(document.type, document.type) }}</span>
                </div>
                <div class="meta-item">
                    <span class="meta-label">Created:</span>
                    <span class="meta-value">{{ document.created_at|datetime }}</span>
                </div>
                <div class="meta-item">
                    <span class="meta-label">Processed:</span>
                    <span class="meta-value">{{ document.processed_at|datetime if document.processed_at else 'Not processed' }}</span>
                </div>
            </div>

            {% if document.status == 'pending' or document.status == 'error' %}
            <div class="actions" style="margin-top: 1rem;">
                <button onclick="processDoc({{ document.id }})" class="btn btn-primary">Process Now</button>
            </div>
            {% endif %}

            {% if document.error_message %}
            <div class="alert alert-error" style="margin-top: 1rem;">
                <strong>Error:</strong> {{ document.error_message }}
            </div>
            {% endif %}
        </div>
    </div>

    <!-- Analysis Result -->
    {% if analysis %}
    <div class="card">
        <div class="card-header">
            <h2>Analysis Result</h2>
        </div>
        <div class="card-body">
            <div class="analysis-grid">
                {% if analysis.topic %}
                <div class="analysis-item">
                    <span class="analysis-label">Topic:</span>
                    <span class="badge badge-type">{{ analysis.topic }}</span>
                </div>
                {% endif %}
                {% if analysis.resolution %}
                <div class="analysis-item">
                    <span class="analysis-label">Resolution:</span>
                    <span class="badge badge-{{ analysis.resolution }}">{{ analysis.resolution }}</span>
                </div>
                {% endif %}
                {% if analysis.satisfaction %}
                <div class="analysis-item">
                    <span class="analysis-label">Satisfaction:</span>
                    <span class="badge badge-{{ analysis.satisfaction }}">{{ analysis.satisfaction }}</span>
                </div>
                {% endif %}
            </div>

            {% if analysis.problem %}
            <div class="analysis-section">
                <h4>Problem:</h4>
                <p>{{ analysis.problem }}</p>
            </div>
            {% endif %}

            {% if analysis.solution %}
            <div class="analysis-section">
                <h4>Solution:</h4>
                <p>{{ analysis.solution }}</p>
            </div>
            {% endif %}

            {% if analysis.summary %}
            <div class="analysis-section">
                <h4>Summary:</h4>
                <p>{{ analysis.summary }}</p>
            </div>
            {% endif %}

            {% if analysis.problem_keywords %}
            <div class="analysis-section">
                <h4>Keywords:</h4>
                <div class="keywords">
                    {% for kw in analysis.problem_keywords %}
                    <span class="badge badge-category">{{ kw }}</span>
                    {% endfor %}
                </div>
            </div>
            {% endif %}
        </div>
    </div>
    {% endif %}

    <!-- Document Content -->
    <div class="card">
        <div class="card-header">
            <h2>Content</h2>
        </div>
        <div class="card-body">
            <pre class="content-preview">{{ document.content if document.content else 'No content' }}</pre>
        </div>
    </div>
</div>

{% endblock %}

{% block head %}
<style>
.analysis-grid {
    display: flex;
    gap: 2rem;
    margin-bottom: 1.5rem;
    flex-wrap: wrap;
}

.analysis-item {
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.analysis-label {
    font-weight: 500;
    color: #666;
}

.analysis-section {
    margin-top: 1.5rem;
    padding-top: 1rem;
    border-top: 1px solid #eee;
}

.analysis-section h4 {
    font-size: 0.9rem;
    color: #666;
    margin-bottom: 0.5rem;
}

.analysis-section p {
    color: #333;
    line-height: 1.6;
}

.keywords {
    display: flex;
    gap: 0.5rem;
    flex-wrap: wrap;
}

.badge-resolved { background: #d4edda; color: #155724; }
.badge-partial { background: #fff3cd; color: #856404; }
.badge-unresolved { background: #f8d7da; color: #721c24; }
.badge-unknown { background: #e9ecef; color: #495057; }
.badge-positive { background: #d4edda; color: #155724; }
.badge-neutral { background: #e9ecef; color: #495057; }
.badge-negative { background: #f8d7da; color: #721c24; }
</style>
{% endblock %}

{% block scripts %}
<script>
function processDoc(docId) {
    if (!confirm('Process this document now?')) return;

    fetch('/api/process/' + docId, { method: 'POST' })
        .then(r => r.json())
        .then(data => {
            if (data.success) {
                alert('Document processed successfully');
                location.reload();
            } else {
                alert('Processing failed');
            }
        })
        .catch(err => alert('Error: ' + err));
}
</script>
{% endblock %}
