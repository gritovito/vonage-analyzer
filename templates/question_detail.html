{% extends "base.html" %}

{% block title %}{{ question.canonical_text|truncate_text(50) }} - Response Scripts Library{% endblock %}

{% block content %}
<!-- Breadcrumb -->
<nav class="breadcrumb">
    <a href="{{ url_for('index') }}">Home</a>
    <span class="separator">/</span>
    <a href="{{ url_for('cluster_detail', cluster_id=question.cluster_id) }}">{{ question.cluster_name }}</a>
    {% if question.subcategory_name %}
    <span class="separator">/</span>
    <a href="{{ url_for('subcategory_detail', subcategory_id=question.subcategory_id) }}">{{ question.subcategory_name }}</a>
    {% endif %}
    <span class="separator">/</span>
    <span class="current">Question</span>
</nav>

<!-- Question Header -->
<div class="question-header">
    <div class="question-badge-large" style="background-color: {{ question.cluster_color }}20; color: {{ question.cluster_color }}">
        {{ question.cluster_icon }}
    </div>
    <div class="question-header-content">
        <h1>{{ question.canonical_text }}</h1>
        <div class="question-meta">
            <span class="cluster-tag" style="background-color: {{ question.cluster_color }}20; color: {{ question.cluster_color }}">
                {{ question.cluster_icon }} {{ question.cluster_name }}
            </span>
            {% if question.subcategory_name %}
            <span class="subcategory-tag">{{ question.subcategory_name }}</span>
            {% endif %}
            <span class="times-asked">Asked {{ question.times_asked }} times</span>
            <span class="status-badge status-{{ question.status }}">{{ question.status }}</span>
        </div>
    </div>
</div>

<!-- Best Script Card (Highlighted) -->
{% if best_script %}
<div class="best-script-section">
    <div class="best-script-header">
        <span class="best-label">Best Response</span>
        <span class="effectiveness-score">{{ best_script.effectiveness|round(0)|int }}% effective</span>
    </div>
    <div class="best-script-content">
        <div class="script-text-large">{{ best_script.script_text }}</div>
        <div class="script-meta">
            <span class="script-type type-{{ best_script.script_type }}">{{ best_script.script_type }}</span>
            {% if best_script.has_steps %}<span class="has-steps">Step-by-step</span>{% endif %}
            <span class="vote-info">{{ best_script.success_count }} helpful / {{ best_script.fail_count }} not helpful</span>
        </div>
        <div class="script-actions">
            <button onclick="copyScript({{ best_script.id }})" class="btn-copy-large">Copy Script</button>
            <button onclick="feedback({{ best_script.id }}, true)" class="btn-helpful">Helpful</button>
            <button onclick="feedback({{ best_script.id }}, false)" class="btn-not-helpful">Not Helpful</button>
        </div>
    </div>
</div>
{% endif %}

<!-- Other Scripts -->
{% if other_scripts %}
<div class="section">
    <h2>Other Response Scripts</h2>
    <div class="scripts-grid">
        {% for script in other_scripts %}
        <div class="script-card">
            <div class="script-effectiveness">{{ script.effectiveness|round(0)|int }}%</div>
            <div class="script-text">{{ script.script_text }}</div>
            <div class="script-meta">
                <span class="script-type type-{{ script.script_type }}">{{ script.script_type }}</span>
                {% if script.has_steps %}<span class="has-steps">Steps</span>{% endif %}
                <span class="vote-info">{{ script.success_count }}/{{ script.fail_count }}</span>
            </div>
            <div class="script-actions">
                <button onclick="copyScript({{ script.id }})" class="btn-copy">Copy</button>
                <button onclick="feedback({{ script.id }}, true)" class="btn-up">+</button>
                <button onclick="feedback({{ script.id }}, false)" class="btn-down">-</button>
            </div>
        </div>
        {% endfor %}
    </div>
</div>
{% endif %}

<!-- No Scripts -->
{% if not best_script and not other_scripts %}
<div class="empty-scripts-section">
    <h3>No Response Scripts Yet</h3>
    <p>Scripts will be automatically extracted when calls about this topic are processed.</p>
</div>
{% endif %}

<!-- Question Variants -->
{% if variants %}
<div class="section variants-section">
    <h2>How Customers Ask This</h2>
    <div class="variants-list">
        {% for v in variants %}
        <div class="variant-item">"{{ v.variant_text }}"</div>
        {% endfor %}
    </div>
</div>
{% endif %}

<!-- Toast notification -->
<div id="toast" class="toast"></div>
{% endblock %}

{% block scripts %}
<script>
function copyScript(id) {
    fetch('/api/script/' + id + '/copy')
        .then(r => r.json())
        .then(data => {
            if (data.text) {
                navigator.clipboard.writeText(data.text).then(() => {
                    showToast('Copied to clipboard!');
                }).catch(() => {
                    const textarea = document.createElement('textarea');
                    textarea.value = data.text;
                    document.body.appendChild(textarea);
                    textarea.select();
                    document.execCommand('copy');
                    document.body.removeChild(textarea);
                    showToast('Copied to clipboard!');
                });
            }
        });
}

function feedback(id, helpful) {
    fetch('/api/script/' + id + '/feedback', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ helpful: helpful })
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) {
            showToast(helpful ? 'Thanks for the feedback!' : 'Thanks, we\'ll improve this.');
            setTimeout(() => location.reload(), 1000);
        }
    });
}

function showToast(message) {
    const toast = document.getElementById('toast');
    toast.textContent = message;
    toast.classList.add('show');
    setTimeout(() => toast.classList.remove('show'), 2000);
}
</script>
{% endblock %}
