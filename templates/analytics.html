{% extends "base.html" %}

{% block title %}Analytics - Call Analyzer{% endblock %}

{% block head %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
{% endblock %}

{% block content %}
<div class="page-header">
    <h1>Analytics</h1>
</div>

<!-- Overview Stats -->
<div class="stats-grid">
    <div class="stat-card">
        <div class="stat-value">{{ stats.total_questions }}</div>
        <div class="stat-label">Questions</div>
    </div>
    <div class="stat-card">
        <div class="stat-value">{{ stats.total_answers }}</div>
        <div class="stat-label">Answers</div>
    </div>
    <div class="stat-card stat-processed">
        <div class="stat-value">{{ stats.resolved_count }}</div>
        <div class="stat-label">Resolved</div>
    </div>
    <div class="stat-card stat-error">
        <div class="stat-value">{{ stats.unresolved_count }}</div>
        <div class="stat-label">Unresolved</div>
    </div>
    <div class="stat-card">
        <div class="stat-value">{{ stats.total_transcriptions }}</div>
        <div class="stat-label">Transcriptions</div>
    </div>
    <div class="stat-card">
        <div class="stat-value">{{ stats.total_knowledge }}</div>
        <div class="stat-label">Knowledge Items</div>
    </div>
</div>

<!-- Charts -->
<div class="charts-grid">
    <!-- Activity Chart -->
    <div class="card">
        <div class="card-header">
            <h2>Activity (Last 30 Days)</h2>
        </div>
        <div class="card-body">
            <canvas id="activityChart"></canvas>
        </div>
    </div>

    <!-- Questions by Topic -->
    <div class="card">
        <div class="card-header">
            <h2>Questions by Topic</h2>
        </div>
        <div class="card-body">
            <canvas id="topicChart"></canvas>
        </div>
    </div>
</div>

<!-- Resolution Chart -->
<div class="card">
    <div class="card-header">
        <h2>Resolution Rate (Last 30 Days)</h2>
    </div>
    <div class="card-body">
        <canvas id="resolutionChart" style="max-height: 300px;"></canvas>
    </div>
</div>

<!-- Daily Summary Table -->
<div class="card">
    <div class="card-header">
        <h2>Daily Summary</h2>
    </div>
    <div class="card-body">
        {% if summary %}
        <table class="table">
            <thead>
                <tr>
                    <th>Date</th>
                    <th>Calls</th>
                    <th>New Questions</th>
                    <th>New Answers</th>
                    <th>Resolved</th>
                    <th>Unresolved</th>
                </tr>
            </thead>
            <tbody>
                {% for s in summary %}
                <tr>
                    <td>{{ s.date }}</td>
                    <td>{{ s.total_calls }}</td>
                    <td>{{ s.new_questions }}</td>
                    <td>{{ s.new_answers }}</td>
                    <td><span class="badge badge-processed">{{ s.resolved_count }}</span></td>
                    <td><span class="badge badge-error">{{ s.unresolved_count }}</span></td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        {% else %}
        <p class="empty-state">No data available yet. Process some call transcriptions to see analytics.</p>
        {% endif %}
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
const chartData = {{ chart_data|safe }};

// Activity Chart
const activityCtx = document.getElementById('activityChart').getContext('2d');
new Chart(activityCtx, {
    type: 'line',
    data: {
        labels: chartData.dates,
        datasets: [{
            label: 'Calls Processed',
            data: chartData.calls,
            borderColor: '#4a90d9',
            backgroundColor: 'rgba(74, 144, 217, 0.1)',
            fill: true,
            tension: 0.3
        }, {
            label: 'New Questions',
            data: chartData.questions,
            borderColor: '#9b59b6',
            backgroundColor: 'rgba(155, 89, 182, 0.1)',
            fill: true,
            tension: 0.3
        }]
    },
    options: {
        responsive: true,
        plugins: {
            legend: {
                position: 'bottom'
            }
        },
        scales: {
            y: {
                beginAtZero: true
            }
        }
    }
});

// Topic Chart
const topicData = {
    {% for topic in questions_by_topic %}
    '{{ topic.icon }} {{ topic.name }}': {{ topic.count }},
    {% endfor %}
};

const topicCtx = document.getElementById('topicChart').getContext('2d');
new Chart(topicCtx, {
    type: 'doughnut',
    data: {
        labels: Object.keys(topicData),
        datasets: [{
            data: Object.values(topicData),
            backgroundColor: [
                '#e74c3c',
                '#3498db',
                '#2ecc71',
                '#9b59b6',
                '#f39c12',
                '#95a5a6'
            ]
        }]
    },
    options: {
        responsive: true,
        plugins: {
            legend: {
                position: 'bottom'
            }
        }
    }
});

// Resolution Chart
const resolutionCtx = document.getElementById('resolutionChart').getContext('2d');
new Chart(resolutionCtx, {
    type: 'bar',
    data: {
        labels: chartData.dates,
        datasets: [{
            label: 'Resolved',
            data: chartData.resolved,
            backgroundColor: '#28a745'
        }, {
            label: 'Unresolved',
            data: chartData.unresolved,
            backgroundColor: '#dc3545'
        }]
    },
    options: {
        responsive: true,
        plugins: {
            legend: {
                position: 'bottom'
            }
        },
        scales: {
            x: {
                stacked: true
            },
            y: {
                stacked: true,
                beginAtZero: true
            }
        }
    }
});
</script>
{% endblock %}
