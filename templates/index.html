{% extends "base.html" %}

{% block title %}Dashboard - Knowledge Hub{% endblock %}

{% block content %}
<div class="page-header">
    <h1>Dashboard</h1>
    <div class="header-actions">
        <button class="btn btn-primary" onclick="scanAndProcess()">Scan & Process</button>
    </div>
</div>

<!-- Overview Stats -->
<div class="stats-grid">
    <div class="stat-card">
        <div class="stat-value">{{ stats.total_questions }}</div>
        <div class="stat-label">Questions</div>
    </div>
    <div class="stat-card">
        <div class="stat-value">{{ stats.total_answers }}</div>
        <div class="stat-label">Answers</div>
    </div>
    <div class="stat-card stat-processed">
        <div class="stat-value">{{ stats.resolved_count }}</div>
        <div class="stat-label">Resolved</div>
    </div>
    <div class="stat-card stat-warning">
        <div class="stat-value">{{ stats.needs_work_count }}</div>
        <div class="stat-label">Needs Work</div>
    </div>
    <div class="stat-card">
        <div class="stat-value">{{ stats.total_documents }}</div>
        <div class="stat-label">Documents</div>
    </div>
    <div class="stat-card stat-pending">
        <div class="stat-value">{{ stats.pending_documents }}</div>
        <div class="stat-label">Pending</div>
    </div>
</div>

<!-- Clusters Overview -->
<div class="card">
    <div class="card-header">
        <h2>Clusters</h2>
        <a href="{{ url_for('clusters') }}" class="btn btn-sm">View All</a>
    </div>
    <div class="card-body">
        <div class="clusters-grid">
            {% for cluster in clusters %}
            <a href="{{ url_for('cluster_detail', cluster_id=cluster.id) }}" class="cluster-card" style="border-left-color: {{ cluster.color }}">
                <div class="cluster-icon">{{ cluster.icon }}</div>
                <div class="cluster-info">
                    <div class="cluster-name">{{ cluster.name }}</div>
                    <div class="cluster-stats">
                        <span>{{ cluster.question_count }} questions</span>
                        <span class="resolved">{{ cluster.resolved_count }} resolved</span>
                    </div>
                </div>
            </a>
            {% endfor %}
        </div>
    </div>
</div>

<div class="grid-2">
    <!-- Top Questions -->
    <div class="card">
        <div class="card-header">
            <h2>Top Questions</h2>
        </div>
        <div class="card-body">
            {% if top_questions %}
            <ul class="question-list">
                {% for q in top_questions %}
                <li>
                    <a href="{{ url_for('question_detail', question_id=q.id) }}">
                        <span class="cluster-badge" style="background-color: {{ q.cluster_color }}">{{ q.cluster_icon }}</span>
                        <span class="question-text">{{ q.canonical_text|truncate_text(60) }}</span>
                        <span class="question-stats">
                            <span class="times-asked">{{ q.times_asked }}x</span>
                            <span class="status-badge status-{{ q.status }}">{{ q.status }}</span>
                        </span>
                    </a>
                </li>
                {% endfor %}
            </ul>
            {% else %}
            <p class="empty-state">No questions yet</p>
            {% endif %}
        </div>
    </div>

    <!-- Needs Work -->
    <div class="card">
        <div class="card-header">
            <h2>Needs Work</h2>
            <a href="{{ url_for('needs_work') }}" class="btn btn-sm">View All</a>
        </div>
        <div class="card-body">
            {% if needs_work %}
            <ul class="question-list">
                {% for q in needs_work %}
                <li>
                    <a href="{{ url_for('question_detail', question_id=q.id) }}">
                        <span class="cluster-badge" style="background-color: {{ q.cluster_color }}">{{ q.cluster_icon }}</span>
                        <span class="question-text">{{ q.canonical_text|truncate_text(60) }}</span>
                        <span class="question-stats">
                            <span class="times-asked">{{ q.times_asked }}x</span>
                        </span>
                    </a>
                </li>
                {% endfor %}
            </ul>
            {% else %}
            <p class="empty-state">No questions need work</p>
            {% endif %}
        </div>
    </div>
</div>

<!-- Recent Documents -->
<div class="card">
    <div class="card-header">
        <h2>Recent Documents</h2>
        <a href="{{ url_for('documents') }}" class="btn btn-sm">View All</a>
    </div>
    <div class="card-body">
        {% if recent_docs %}
        <table class="table">
            <thead>
                <tr>
                    <th>Filename</th>
                    <th>Status</th>
                    <th>Processed</th>
                </tr>
            </thead>
            <tbody>
                {% for doc in recent_docs %}
                <tr>
                    <td><a href="{{ url_for('document_detail', doc_id=doc.id) }}">{{ doc.filename }}</a></td>
                    <td><span class="badge badge-{{ doc.status }}">{{ doc.status }}</span></td>
                    <td>{{ doc.processed_at|datetime }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        {% else %}
        <p class="empty-state">No documents yet</p>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
function scanAndProcess() {
    const btn = event.target;
    btn.disabled = true;
    btn.textContent = 'Processing...';

    fetch('/api/process-all', { method: 'POST' })
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                alert(data.error);
            } else {
                alert(`Processed: ${data.processed}, Errors: ${data.errors}, New files: ${data.new_files}`);
                location.reload();
            }
        })
        .catch(err => alert('Error: ' + err))
        .finally(() => {
            btn.disabled = false;
            btn.textContent = 'Scan & Process';
        });
}
</script>
{% endblock %}
